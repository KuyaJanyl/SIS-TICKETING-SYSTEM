<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Tickets - Shalom Ticket System</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Teal & Green Theme */
    .bg-header {
      background: linear-gradient(135deg, #14b8a6, #22c55e);
    }
    .btn-logout {
      background-color: #ef4444;
    }
    .btn-logout:hover {
      background-color: #dc2626;
    }
    .table-header {
      background-color: #14b8a6;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDvtwYFWIYqyoOA3fB3d9LfNadMPwB04aU",
      authDomain: "shalomlabapps.firebaseapp.com",
      databaseURL: "https://shalomlabapps-default-rtdb.firebaseio.com",
      projectId: "shalomlabapps",
      storageBucket: "shalomlabapps.firebasestorage.app",
      messagingSenderId: "491098279306",
      appId: "1:491098279306:web:ab80d08ab64b27ae80cc73",
      measurementId: "G-2J6GD16PK9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ticketsTable = document.getElementById("ticketsTable");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        let q = query(collection(db, "tickets"), where("userId", "==", user.uid));
        let snap = await getDocs(q);

        // If no results by userId, try email
        if (snap.empty) {
          q = query(collection(db, "tickets"), where("email", "==", user.email));
          snap = await getDocs(q);
        }

        // If still empty, no tickets
        if (snap.empty) {
          ticketsTable.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">No tickets found</td></tr>`;
          return;
        }

        // Convert to array for sorting
        let tickets = [];
        snap.forEach(docSnap => {
          let data = docSnap.data();
          tickets.push({ id: docSnap.id, ...data });
        });

        // Sort by date
        tickets.sort((a, b) => {
          let dateA = a.date ? new Date(a.date.toDate ? a.date.toDate() : a.date) : 0;
          let dateB = b.date ? new Date(b.date.toDate ? b.date.toDate() : b.date) : 0;
          return dateB - dateA;
        });

        // Render table
        tickets.forEach(ticket => {
          let formattedDate = ticket.date
            ? (ticket.date.toDate ? ticket.date.toDate().toLocaleString() : new Date(ticket.date).toLocaleString())
            : "N/A";

          ticketsTable.innerHTML += `
            <tr class="border-b hover:bg-green-50 transition">
              <td class="px-4 py-2">${ticket.id}</td>
              <td class="px-4 py-2">${ticket.name || "N/A"}</td>
              <td class="px-4 py-2">${ticket.email || "N/A"}</td>
              <td class="px-4 py-2">${ticket.branch || "N/A"}</td>
              <td class="px-4 py-2">${ticket.department || "N/A"}</td>
              <td class="px-4 py-2">${ticket.concern || "No Concern Provided"}</td>
              <td class="px-4 py-2 font-semibold ${ticket.status === 'Resolved' ? 'text-green-600' : 'text-yellow-600'}">
                ${ticket.status || "Pending"}
              </td>
              <td class="px-4 py-2">${formattedDate}</td>
            </tr>
          `;
        });

      } catch (err) {
        console.error("Error loading tickets:", err);
        ticketsTable.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Error loading tickets: ${err.message}</td></tr>`;
      }
    });

    // Logout function
    window.logout = async () => {
      await signOut(auth);
      window.location.href = "login.html";
    };
  </script>
</head>
<body class="bg-gradient-to-r from-green-50 via-white to-teal-50 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-header text-white shadow-md py-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-lg font-semibold">My Tickets</h1>
      <button onclick="logout()" class="btn-logout px-4 py-2 rounded text-white shadow">
        Logout
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200">
      <table class="w-full text-left">
        <thead class="table-header text-white">
          <tr>
            <th class="px-4 py-2">Ticket ID</th>
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Email</th>
            <th class="px-4 py-2">Branch</th>
            <th class="px-4 py-2">Department</th>
            <th class="px-4 py-2">Concern</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Date Created</th>
          </tr>
        </thead>
        <tbody id="ticketsTable" class="bg-white"></tbody>
      </table>
    </div>
  </main>

</body>
</html>
